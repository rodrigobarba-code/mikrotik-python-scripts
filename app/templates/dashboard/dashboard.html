{% extends 'base.html' %}

{% block title %} Dashboard {% endblock %}

{% block head %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/base/styles.css') }}">
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const chartData = {{ dashboard_data|tojson }};
            const publicIpsData = {{ public_ips_data|tojson }};
            const totalIpsData = {{ total_ips_data|tojson }};
            const ctx = document.getElementById('myChart').getContext('2d');
            let currentChart;

            // Función para inicializar o actualizar el gráfico
            function updateChart(site, segment) {
                const data = chartData[site];
                const assigned = data.assigned.find(s => Object.keys(s)[0] === segment);
                const available = data.available.find(s => Object.keys(s)[0] === segment);

                const assignedQuantity = assigned ? Object.values(assigned)[0].quantity : 0;
                const availableQuantity = available ? Object.values(available)[0].quantity : 0;

                const chartConfig = {
                    type: 'doughnut',
                    data: {
                        labels: ['Assigned', 'Available'],
                        datasets: [{
                            label: 'Private IPs',
                            data: [assignedQuantity, availableQuantity],
                            backgroundColor: ['#FF6384', '#36A2EB'],
                        }]
                    },
                };

                if (currentChart) {
                    currentChart.destroy();
                }

                currentChart = new Chart(ctx, chartConfig);
            }

            // Función para actualizar los filtros
            function updateFilters() {
                const siteSelect = document.getElementById('siteFilter');
                const segmentSelect = document.getElementById('segmentFilter');
                const selectedSite = siteSelect.value;

                segmentSelect.innerHTML = '';
                if (chartData[selectedSite]) {
                    chartData[selectedSite].assigned.forEach(segment => {
                        const segmentKey = Object.keys(segment)[0];
                        const option = document.createElement('option');
                        option.value = segmentKey;
                        option.textContent = segmentKey;
                        segmentSelect.appendChild(option);
                    });
                }

                updateChart(selectedSite, segmentSelect.value);
            }

            // Agregar evento change al select de sitios
            document.getElementById('siteFilter').addEventListener('change', updateFilters);

            // Agregar evento change al select de segmentos
            document.getElementById('segmentFilter').addEventListener('change', function () {
                const siteSelect = document.getElementById('siteFilter');
                const segmentSelect = document.getElementById('segmentFilter');
                updateChart(siteSelect.value, segmentSelect.value);
            });

            // Inicializar los filtros al cargar la página
            updateFilters();
        });
    </script>
{% endblock %}

{% block content %}
    <!-- Dashboard Jumbotron -->
    <section class="dashboard-jumbotron">
        <div class="container-fluid py-5 overview-container">
            <h1 class="display-5 fw-bold">Overview</h1>
        </div>
    </section>
    <!-- Dashboard Jumbotron -->

    <!-- Overview Card-Top -->
    <div class="container card-top-container">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 card-container">
                <div class="d-flex justify-content-evenly">
                    <div class="card card-top">
                        <div class="card-body">
                            <h5 class="card-title">Total IPs</h5>
                            <span class="badge rounded-pill">
                                {{ total_ips_data.total }}
                            </span>
                        </div>
                    </div>
                    <div class="card card-top">
                        <div class="card-body">
                            <h5 class="card-title">Anomalies found</h5>
                            <span class="badge rounded-pill">
                                {{ total_ips_data.count_arps }}
                            </span>
                        </div>
                    </div>
                    <div class="card card-top">
                        <div class="card-body">
                            <h5 class="card-title">Blacklist/Authorized found</h5>
                            <span class="badge rounded-pill">
                                {{ total_ips_data.count_ip_groups }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Overview Card-Top -->

    <!-- Dashboard Content -->
    <div class="container-fluid">
        <div class="container">
            <div class="row">
                <!-- Panel 1 -->
                <div class="col-lg-4 col-md-6 col-sm-12 dashboard-content">
                    <div class="card p-3">
                        <h5 class="card-title">Assigned vs Available Private IP</h5>

                        <!-- Selector para elegir el tipo de estadísticas -->
                        <label for="siteFilter" class="form-label">Select a site:</label>
                        <select id="siteFilter" class="form-select mb-3">
                            {% for site in sites %}
                                <option value="{{ site[1] }}">{{ site[1] }}</option>
                            {% endfor %}
                        </select>

                        <!-- Selector para elegir el segmento -->
                        <label for="segmentFilter" class="form-label">Select a segment:</label>
                        <select id="segmentFilter" class="form-select mb-3">
                            <!-- Opciones de segmento se llenarán dinámicamente -->
                        </select>
                        <!-- Canvas para el gráfico -->
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
                <!-- Panel 2 -->
                <div class="col-lg-4 col-md-6 col-sm-12 dashboard-content">
                    <div class="card p-3">
                        <h5 class="card-title">Assigned vs Available Public IP</h5>

                        <!-- Selector para elegir el tipo de estadísticas -->
                        <label for="site-select" class="form-label">Select a site:</label>
                        <select id="site-select" class="form-select mb-3">
                            {% for site in sites %}
                                <option value="{{ site[1] }}">{{ site[1] }}</option>
                            {% endfor %}
                        </select>

                        <!-- Selector para elegir el segmento -->
                        <label for="segment-select" class="form-label">Select a segment:</label>
                        <select id="segment-select" class="form-select mb-3">
                            <!-- Opciones de segmento se llenarán dinámicamente -->
                        </select>
                        <!-- Canvas para el gráfico -->
                        <canvas id="publicIpChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Dashboard Content -->
{% endblock %}
